<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Agent Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #667eea;
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-color: #6c757d;
        --success-color: #10b981;
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --info-color: #3b82f6;
        --info-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        --warning-color: #f59e0b;
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-color: #ef4444;
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --light-color: #f8fafc;
        --dark-color: #1e293b;
        --text-color: #334155;
        --text-muted: #64748b;
        --bg-color: #f1f5f9;
        --card-bg: #ffffff;
        --border-color: #e2e8f0;
        --table-header-bg: #f8fafc;
        --table-row-even: #f8fafc;
        --table-row-hover: #e2e8f0;
        --input-bg: #ffffff;
        --input-border: #d1d5db;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      [data-theme="dark"] {
        --primary-color: #818cf8;
        --primary-gradient: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
        --secondary-color: #9ca3af;
        --success-color: #34d399;
        --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        --info-color: #60a5fa;
        --info-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        --warning-color: #fbbf24;
        --warning-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        --danger-color: #f87171;
        --danger-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        --light-color: #1e293b;
        --dark-color: #f1f5f9;
        --text-color: #e2e8f0;
        --text-muted: #94a3b8;
        --bg-color: #0f172a;
        --card-bg: #1e293b;
        --border-color: #334155;
        --table-header-bg: #334155;
        --table-row-even: #1e293b;
        --table-row-hover: #334155;
        --input-bg: #334155;
        --input-border: #475569;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4),
          0 2px 4px -1px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4),
          0 4px 6px -2px rgba(0, 0, 0, 0.3);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4),
          0 10px 10px -5px rgba(0, 0, 0, 0.3);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding: 24px 32px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
      }

      h1 {
        margin: 0;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      h1::before {
        content: "📊";
        font-size: 1.5rem;
      }

      .theme-toggle {
        background: var(--primary-gradient);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
      }

      .theme-toggle::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .theme-toggle:hover::before {
        left: 100%;
      }

      .theme-toggle:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
        background: var(--card-bg);
        padding: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
      }

      .filters::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      label {
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      label::before {
        content: "•";
        color: var(--primary-color);
        font-weight: bold;
      }

      select,
      input {
        padding: 12px 16px;
        border-radius: 12px;
        border: 2px solid var(--input-border);
        background-color: var(--input-bg);
        color: var(--text-color);
        transition: all 0.3s ease;
        font-size: 0.875rem;
        font-weight: 500;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
      }

      button {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        align-self: flex-end;
        height: fit-content;
        margin-top: auto;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      button:hover::before {
        left: 100%;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
      }

      button:active {
        transform: translateY(0);
      }

      #metrics {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .metric-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .metric-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
      }

      .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
      }

      .metric-card:nth-child(2)::before {
        background: var(--success-gradient);
      }
      .metric-card:nth-child(3)::before {
        background: var(--info-gradient);
      }
      .metric-card:nth-child(4)::before {
        background: var(--warning-gradient);
      }
      .metric-card:nth-child(5)::before {
        background: var(--danger-gradient);
      }
      .metric-card:nth-child(6)::before {
        background: var(--primary-gradient);
      }
      .metric-card:nth-child(7)::before {
        background: var(--success-gradient);
      }
      .metric-card:nth-child(8)::before {
        background: var(--info-gradient);
      }
      .metric-card:nth-child(9)::before {
        background: var(--warning-gradient);
      }

      .metric-card h3 {
        margin: 0 0 12px 0;
        color: var(--text-muted);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .metric-card p {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .metric-card:nth-child(2) p {
        background: var(--success-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .metric-card:nth-child(3) p {
        background: var(--info-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .metric-card:nth-child(4) p {
        background: var(--warning-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .metric-card:nth-child(5) p {
        background: var(--danger-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 32px;
        margin-bottom: 32px;
      }

      .chart-container {
        background: var(--card-bg);
        padding: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
      }

      .chart-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
      }

      .chart-container:nth-child(2)::before {
        background: var(--success-gradient);
      }
      .chart-container:nth-child(3)::before {
        background: var(--info-gradient);
      }

      canvas {
        width: 100% !important;
        height: 350px !important;
      }

      #purchaseTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 32px;
        background: var(--card-bg);
        box-shadow: var(--shadow-lg);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }

      #purchaseTable th {
        background: var(--table-header-bg);
        padding: 16px 20px;
        text-align: left;
        font-weight: 700;
        color: var(--text-color);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border-color);
      }

      #purchaseTable td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        font-weight: 500;
        transition: all 0.2s ease;
      }

      #purchaseTable tbody tr:nth-child(even) {
        background-color: var(--table-row-even);
      }

      #purchaseTable tbody tr:hover {
        background-color: var(--table-row-hover);
        transform: scale(1.01);
        box-shadow: var(--shadow-md);
      }

      #noDataMessage {
        background: var(--warning-gradient);
        color: white;
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 32px;
        text-align: center;
        font-weight: 600;
        display: none;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      #noDataMessage::before {
        content: "⚠️";
        font-size: 2rem;
        display: block;
        margin-bottom: 8px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .metric-card,
      .chart-container,
      .filters,
      header {
        animation: fadeIn 0.6s ease-out;
      }

      .metric-card:nth-child(1) {
        animation-delay: 0.1s;
      }
      .metric-card:nth-child(2) {
        animation-delay: 0.2s;
      }
      .metric-card:nth-child(3) {
        animation-delay: 0.3s;
      }
      .metric-card:nth-child(4) {
        animation-delay: 0.4s;
      }
      .metric-card:nth-child(5) {
        animation-delay: 0.5s;
      }
      .metric-card:nth-child(6) {
        animation-delay: 0.6s;
      }
      .metric-card:nth-child(7) {
        animation-delay: 0.7s;
      }
      .metric-card:nth-child(8) {
        animation-delay: 0.8s;
      }
      .metric-card:nth-child(9) {
        animation-delay: 0.9s;
      }

      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        header {
          flex-direction: column;
          gap: 16px;
          text-align: center;
          padding: 20px;
        }

        h1 {
          font-size: 1.5rem;
        }

        .filters {
          grid-template-columns: 1fr;
          padding: 24px;
        }

        .charts {
          grid-template-columns: 1fr;
        }

        #metrics {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        #purchaseTable {
          font-size: 0.875rem;
        }

        #purchaseTable th,
        #purchaseTable td {
          padding: 12px 8px;
        }
      }

      @media (max-width: 480px) {
        #metrics {
          grid-template-columns: 1fr;
        }

        .metric-card {
          padding: 20px;
        }

        .chart-container {
          padding: 20px;
        }

        canvas {
          height: 250px !important;
        }
      }

      /* Loading animation */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-color);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-color);
        opacity: 0.8;
      }

      /* Table section CSS */
      .table-section {
        margin-top: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        overflow: hidden;
      }

      #purchaseTable {
        font-size: 0.85rem;
        border-collapse: collapse;
        width: 100%;
      }

      #purchaseTable thead,
      #purchaseTable tbody {
        display: block;
      }

      #purchaseTable thead {
        background: var(--table-header-bg);
      }

      #purchaseTable tbody {
        max-height: 400px;
        overflow-y: auto;
      }

      #purchaseTable tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      #purchaseTable th,
      #purchaseTable td {
        padding: 12px 16px;
        text-align: left;
        box-sizing: border-box;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
      }

      /* Column width matching (8 columns) */
      #purchaseTable th:nth-child(1),
      #purchaseTable td:nth-child(1) {
        width: 22%;
      } /* Email - wider */
      #purchaseTable th:nth-child(2),
      #purchaseTable td:nth-child(2) {
        width: 14%;
      } /* Phone */
      #purchaseTable th:nth-child(3),
      #purchaseTable td:nth-child(3) {
        width: 24%;
      } /* Product - more room */
      #purchaseTable th:nth-child(4),
      #purchaseTable td:nth-child(4) {
        width: 10%;
      } /* Price */
      #purchaseTable th:nth-child(5),
      #purchaseTable td:nth-child(5) {
        width: 10%;
      } /* COGS */
      #purchaseTable th:nth-child(6),
      #purchaseTable td:nth-child(6) {
        width: 10%;
      } /* Profit */
      #purchaseTable th:nth-child(7),
      #purchaseTable td:nth-child(7) {
        width: 16%;
      } /* Order Time */
      #purchaseTable th:nth-child(8),
      #purchaseTable td:nth-child(8) {
        width: 10%;
      } /* Order # */

      #purchaseTable th {
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-color);
        border-bottom: 2px solid var(--border-color);
      }

      #purchaseTable tbody tr:nth-child(even) {
        background-color: var(--table-row-even);
      }

      #purchaseTable tbody tr:hover {
        background-color: var(--table-row-hover);
        transform: scale(1.01);
        box-shadow: var(--shadow-md);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Voice Agent Dashboard</h1>
        <button id="themeToggle" class="theme-toggle">
          <i id="theme-icon" class="fas fa-moon"></i>
          <span id="theme-text">Dark Mode</span>
        </button>
      </header>

      <div class="filters">
        <div class="filter-group">
          <label for="brand"><i class="fas fa-tag"></i> Brand</label>
          <select id="brand">
            <option value="all">All Brands</option>
            <option value="trimfinity">Trimfinity</option>
            <option value="urbanyog">UrbanYog</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="startDate"
            ><i class="fas fa-calendar-alt"></i> Start Date</label
          >
          <input type="date" id="startDate" />
        </div>
        <div class="filter-group">
          <label for="endDate"
            ><i class="fas fa-calendar-alt"></i> End Date</label
          >
          <input type="date" id="endDate" />
        </div>
        <div class="filter-group">
          <label for="groupBy"><i class="fas fa-chart-bar"></i> Group By</label>
          <select id="groupBy">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
            <option value="quarter">Quarterly</option>
          </select>
        </div>
        <button id="applyFilters">
          <i class="fas fa-filter"></i>
          Apply Filters
        </button>
      </div>

      <div id="noDataMessage">
        <strong>No data available in selected date range.</strong>
        <p>Try adjusting your filters or selecting a different date range.</p>
      </div>

      <div id="metrics"></div>

      <div class="charts">
        <div class="chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="callDurationChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="productPieChart"></canvas>
        </div>
      </div>

      <div class="table-section">
        <table id="purchaseTable">
          <thead>
            <tr>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-phone"></i> Phone</th>
              <th><i class="fas fa-box"></i> Product</th>
              <th><i class="fas fa-rupee-sign"></i> Price</th>
              <th><i class="fas fa-calculator"></i> COGS</th>
              <th><i class="fas fa-chart-line"></i> Profit</th>
              <th><i class="fas fa-clock"></i> Order Time</th>
              <th><i class="fas fa-hashtag"></i> Order Number</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <button onclick="exportToExcel()" style="margin-top: 16px">
          <i class="fas fa-file-excel"></i> Export to Excel
        </button>
      </div>
    </div>

    <script>
      // Global chart variables
      let revenueChart, callChart, pieChart;
      let currentTheme = "light";

      // Initialize the dashboard when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize theme
        initTheme();

        // Set default dates (last 30 days)
        // const endDate = new Date();
        // const startDate = new Date();
        // startDate.setDate(startDate.getDate() - 30);

        // document.getElementById('startDate').valueAsDate = startDate;
        // Set default start date to April 1, 2025
        document.getElementById("startDate").value = "2025-04-01";

        // Set default end date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("endDate").value = today;

        // ✅ Set default groupBy BEFORE calling loadDashboard
        document.getElementById("groupBy").value = "day";

        // document.getElementById("endDate").valueAsDate = endDate;

        // Set up event listeners
        document
          .getElementById("themeToggle")
          .addEventListener("click", toggleTheme);
        document
          .getElementById("applyFilters")
          .addEventListener("click", loadDashboard);

        // Load dashboard with default dates
        loadDashboard();
      });

      // Theme functions
      function initTheme() {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        if (savedTheme) {
          currentTheme = savedTheme;
        } else if (prefersDark) {
          currentTheme = "dark";
        }

        applyTheme();
      }

      function toggleTheme() {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme();
        localStorage.setItem("theme", currentTheme);
      }

      function applyTheme() {
        document.documentElement.setAttribute("data-theme", currentTheme);
        const themeIcon = document.getElementById("theme-icon");
        const themeText = document.getElementById("theme-text");

        if (currentTheme === "light") {
          themeIcon.className = "fas fa-moon";
          themeText.textContent = "Dark Mode";
        } else {
          themeIcon.className = "fas fa-sun";
          themeText.textContent = "Light Mode";
        }

        // Update charts if they exist
        updateChartThemes();
      }

      function updateChartThemes() {
        const gridColor =
          currentTheme === "dark"
            ? "rgba(255, 255, 255, 0.1)"
            : "rgba(0, 0, 0, 0.1)";
        const textColor = getComputedStyle(
          document.documentElement
        ).getPropertyValue("--text-color");

        if (revenueChart) {
          revenueChart.options.scales.x.grid.color = gridColor;
          revenueChart.options.scales.y.grid.color = gridColor;
          revenueChart.options.scales.x.ticks.color = textColor;
          revenueChart.options.scales.y.ticks.color = textColor;
          revenueChart.options.plugins.legend.labels.color = textColor;
          revenueChart.update();
        }

        if (callChart) {
          callChart.options.scales.x.grid.color = gridColor;
          callChart.options.scales.y.grid.color = gridColor;
          callChart.options.scales.x.ticks.color = textColor;
          callChart.options.scales.y.ticks.color = textColor;
          callChart.options.plugins.legend.labels.color = textColor;
          callChart.update();
        }

        if (pieChart) {
          pieChart.options.plugins.legend.labels.color = textColor;
          pieChart.update();
        }
      }

      // Dashboard functions
      async function loadDashboard() {
        const brand = document.getElementById("brand").value;
        // const startDate = document.getElementById("startDate").value;
        // const endDate = document.getElementById("endDate").value;
        const groupBy = document.getElementById("groupBy").value;
        let startDate = new Date(document.getElementById("startDate").value);
        let endDate = new Date(document.getElementById("endDate").value);

        // newwwwwwwwww changeeee
        // let startDate = new Date();
        // let endDate = new Date();

        // if (groupBy === "week") {
        //   const now = new Date();
        //   const day = now.getDay();
        //   const diffToLastMonday = ((day + 6) % 7) + 7;
        //   startDate.setDate(now.getDate() - diffToLastMonday);
        //   endDate = new Date(startDate);
        //   endDate.setDate(startDate.getDate() + 6);
        // } else if (groupBy === "month") {
        //   startDate = new Date(
        //     new Date().getFullYear(),
        //     new Date().getMonth() - 1,
        //     1
        //   );
        //   endDate = new Date(
        //     new Date().getFullYear(),
        //     new Date().getMonth(),
        //     0
        //   );
        // } else if (groupBy === "quarter") {
        //   const currentMonth = new Date().getMonth();
        //   const currentQuarter = Math.floor(currentMonth / 3);
        //   const startMonth = ((currentQuarter - 1 + 4) % 4) * 3;
        //   const yearOffset = currentQuarter === 0 ? -1 : 0;
        //   const year = new Date().getFullYear() + yearOffset;
        //   startDate = new Date(year, startMonth, 1);
        //   endDate = new Date(year, startMonth + 3, 0);
        // } else {
        //   // groupBy === 'day' or anything else → show all data from April 1
        //   // startDate = new Date("2025-04-01");
        //   // endDate = new Date();
        //   // Use date pickers for day view
        //   startDate = new Date(document.getElementById("startDate").value);
        //   endDate = new Date(document.getElementById("endDate").value);
        // }

        // Format as YYYY-MM-DD
        const startDateStr = startDate.toISOString().split("T")[0];
        const endDateStr = endDate.toISOString().split("T")[0];

        // Optional: update the date pickers on screen
        document.getElementById("startDate").value = startDateStr;
        document.getElementById("endDate").value = endDateStr;

        console.log("Brand filter:", brand);
        console.log("🔍 Grouping by:", groupBy);

        const url = `/api/dashboard/metrics?start=${startDateStr}&end=${endDateStr}&groupBy=${groupBy}&brand=${brand}`;
        const response = await fetch(url);
        const data = await response.json();

        const noData =
          data.revenueData.labels.length === 0 &&
          data.metrics.total_orders == 0 &&
          data.metrics.total_calls == 0;

        document.getElementById("noDataMessage").style.display = noData
          ? "block"
          : "none";

        if (!noData) {
          renderMetrics(data.metrics);

          if (revenueChart) revenueChart.destroy();
          renderRevenueChart(data.revenueData);

          if (callChart) callChart.destroy();
          renderCallChart(data.callDurationData);

          if (
            data.productDistribution &&
            data.productDistribution.labels?.length > 0
          ) {
            if (pieChart) pieChart.destroy();
            renderPieChart(data.productDistribution);
          } else {
            if (pieChart) pieChart.destroy();
          }

          renderPurchaseTable(data.purchaseList);
        } else {
          document.getElementById("metrics").innerHTML = "";
          document
            .getElementById("purchaseTable")
            .querySelector("tbody").innerHTML = "";
          if (revenueChart) revenueChart.destroy();
          if (callChart) callChart.destroy();
          if (pieChart) pieChart.destroy();
        }
      }

      // function renderMetrics(metrics) {
      //   document.getElementById("metrics").innerHTML = `
      //         <div class="metric-card">
      //           <h3><i class="fas fa-shopping-cart"></i> Total Orders</h3>
      //           <p>${metrics.total_orders}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-rupee-sign"></i> Revenue</h3>
      //           <p>₹${metrics.revenue}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-chart-line"></i> Profit</h3>
      //           <p>₹${metrics.profit}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-phone"></i> Total Calls</h3>
      //           <p>${metrics.total_calls}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-phone-alt"></i> Connected Calls</h3>
      //           <p>${metrics.connected_calls}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-money-bill"></i> Call Cost</h3>
      //           <p>₹${metrics.total_call_cost}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-clock"></i> Total Call Duration</h3>
      //           <p>${metrics.total_duration_min} mins</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-calculator"></i> COGS</h3>
      //           <p>₹${metrics.total_cogs}</p>
      //         </div>
      //         <div class="metric-card">
      //           <h3><i class="fas fa-percentage"></i> Conversion Rate</h3>
      //           <p>${metrics.conversion_rate}</p>
      //         </div>
      //       `;
      // }
      function renderMetrics(metrics) {
        document.getElementById("metrics").innerHTML = `
    <div class="metric-card">
      <h3><i class="fas fa-shopping-cart"></i> Total Orders</h3>
      <p>${parseInt(metrics.total_orders).toLocaleString("en-IN")}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-rupee-sign"></i> Revenue</h3>
      <p>₹${parseFloat(metrics.revenue).toLocaleString("en-IN", {
        minimumFractionDigits: 2,
      })}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-chart-line"></i> Profit</h3>
      <p>₹${parseFloat(metrics.profit).toLocaleString("en-IN", {
        minimumFractionDigits: 2,
      })}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-phone"></i> Total Calls</h3>
      <p>${parseInt(metrics.total_calls).toLocaleString("en-IN")}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-phone-alt"></i> Connected Calls</h3>
      <p>${parseInt(metrics.connected_calls).toLocaleString("en-IN")}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-money-bill"></i> Call Cost</h3>
      <p>₹${parseFloat(metrics.total_call_cost).toLocaleString("en-IN", {
        minimumFractionDigits: 2,
      })}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-clock"></i> Total Call Duration</h3>
      <p>${parseFloat(metrics.total_duration_min).toLocaleString("en-IN", {
        minimumFractionDigits: 2,
      })} mins</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-calculator"></i> COGS</h3>
      <p>₹${parseFloat(metrics.total_cogs).toLocaleString("en-IN", {
        minimumFractionDigits: 2,
      })}</p>
    </div>
    <div class="metric-card">
      <h3><i class="fas fa-percentage"></i> Conversion Rate</h3>
      <p>${metrics.conversion_rate}</p>
    </div>
  `;
      }

      function renderRevenueChart(data) {
        console.log("📊 Revenue Chart Input:", data);

        // Force chronological sort for monthly or quarterly labels
        const isDateStr = (str) => /^\d{4}-\d{2}-\d{2}$/.test(str);
        const isMonthStr = (str) => /^\d{4}-\d{2}$/.test(str);
        const isQuarterStr = (str) => /^\d{4}-Q\d$/.test(str);

        if (data.labels.length > 0) {
          const combined = data.labels.map((label, i) => ({
            label,
            revenue: data.revenue[i],
            profit: data.profit[i],
          }));

          const parse = (label) => {
            if (isQuarterStr(label)) {
              const [year, q] = label.split("-Q").map(Number);
              return new Date(year, (q - 1) * 3, 1);
            } else if (isDateStr(label)) {
              return new Date(label); // daily or weekly (YYYY-MM-DD)
            } else if (isMonthStr(label)) {
              const [year, month] = label.split("-").map(Number);
              return new Date(year, month - 1, 1);
            } else {
              return new Date(label); // fallback
            }
          };

          combined.sort((a, b) => parse(a.label) - parse(b.label));

          data.labels = combined.map((x) => x.label);
          data.revenue = combined.map((x) => x.revenue);
          data.profit = combined.map((x) => x.profit);
        }

        if (
          !data ||
          !data.labels ||
          data.labels.length === 0 ||
          !data.revenue ||
          data.revenue.length === 0
        ) {
          document.getElementById("revenueChart").style.display = "none";
          return;
        }

        document.getElementById("revenueChart").style.display = "block";

        const ctx = document.getElementById("revenueChart").getContext("2d");
        revenueChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "Revenue",
                data: data.revenue,
                borderWidth: 2,
                tension: 0.3,
              },
              {
                label: "Profit",
                data: data.profit,
                borderWidth: 2,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: "category",
                offset: false,
                grid: {
                  display: false, // hides extra vertical lines
                },
                ticks: {
                  callback: function (val, index) {
                    // Show only 1st, middle, and last labels
                    const total = data.labels.length;
                    if (
                      index === 0 ||
                      index === Math.floor(total / 2) ||
                      index === total - 1
                    ) {
                      return data.labels[index];
                    }
                    return "";
                  },
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  font: {
                    weight: "bold",
                  },
                },
              },
              y: {
                beginAtZero: true,
                ticks: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  font: {
                    weight: "bold",
                  },
                },
                grid: {
                  color:
                    currentTheme === "dark"
                      ? "rgba(255, 255, 255, 0.1)"
                      : "rgba(0, 0, 0, 0.1)",
                  drawBorder: false,
                },
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                },
              },
            },
          },
        });
      }

      function renderCallChart(data) {
        const ctx = document.getElementById("callDurationChart");
        callChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "Call Duration (minutes)",
                data: data.duration,
                backgroundColor: "rgba(59, 130, 246, 0.8)",
                borderColor: "#3b82f6",
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                },
              },
              title: {
                display: true,
                text: "Call Duration Analysis",
                color: getComputedStyle(
                  document.documentElement
                ).getPropertyValue("--text-color"),
                font: {
                  size: 16,
                  weight: "bold",
                },
              },
            },
            scales: {
              x: {
                grid: {
                  color:
                    currentTheme === "dark"
                      ? "rgba(255, 255, 255, 0.1)"
                      : "rgba(0, 0, 0, 0.1)",
                  drawBorder: false,
                },
                ticks: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  font: {
                    weight: "bold",
                  },
                },
              },
              y: {
                beginAtZero: true,
                grid: {
                  color:
                    currentTheme === "dark"
                      ? "rgba(255, 255, 255, 0.1)"
                      : "rgba(0, 0, 0, 0.1)",
                  drawBorder: false,
                },
                ticks: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  font: {
                    weight: "bold",
                  },
                },
              },
            },
          },
        });
      }

      function renderPieChart(data) {
        const ctx = document.getElementById("productPieChart");
        pieChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "Product Share",
                data: data.values,
                backgroundColor: [
                  "#10b981",
                  "#3b82f6",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                  "#06b6d4",
                  "#ec4899",
                  "#6366f1",
                  "#84cc16",
                  "#f97316",
                ],
                borderWidth: 3,
                borderColor: getComputedStyle(
                  document.documentElement
                ).getPropertyValue("--card-bg"),
                hoverBorderWidth: 4,
                hoverOffset: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: getComputedStyle(
                    document.documentElement
                  ).getPropertyValue("--text-color"),
                  padding: 20,
                  usePointStyle: true,
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                },
              },
              title: {
                display: true,
                text: "Product Distribution",
                color: getComputedStyle(
                  document.documentElement
                ).getPropertyValue("--text-color"),
                font: {
                  size: 16,
                  weight: "bold",
                },
              },
            },
            cutout: "60%",
          },
        });
      }

      // function renderPurchaseTable(data) {
      //   const tbody = document
      //     .getElementById("purchaseTable")
      //     .querySelector("tbody");
      //   tbody.innerHTML = "";

      //   data.forEach((row) => {
      //     const tr = document.createElement("tr");
      //     tr.innerHTML = `
      //     <td><i class="fas fa-envelope" style="color: var(--primary-color); margin-right: 8px;"></i>${
      //       row.email
      //     }</td>
      //     <td><i class="fas fa-phone" style="color: var(--success-color); margin-right: 8px;"></i>${
      //       row.phone_number
      //     }</td>
      //     <td><i class="fas fa-box" style="color: var(--info-color); margin-right: 8px;"></i>${
      //       row.title
      //     }</td>
      //     <td><i class="fas fa-rupee-sign" style="color: var(--success-color); margin-right: 8px;"></i>${
      //       row.total_price
      //     }</td>
      //     <td><i class="fas fa-calculator" style="color: var(--warning-color); margin-right: 8px;"></i>${
      //       row.cogs
      //     }</td>
      //     <td><i class="fas fa-chart-line" style="color: var(--success-color); margin-right: 8px;"></i>${
      //       row.profit
      //     }</td>
      //     <td><i class="fas fa-clock" style="color: var(--info-color); margin-right: 8px;"></i>${new Date(
      //       row.created_at
      //     ).toLocaleString()}</td>
      //     <td><i class="fas fa-hashtag" style="color: var(--primary-color); margin-right: 8px;"></i>${
      //       row.order_number
      //     }</td>
      //     <td><i class="fas fa-phone-alt" style="color: var(--success-color); margin-right: 8px;"></i>${new Date(
      //       row.call_time
      //     ).toLocaleString()}</td>
      //   `;
      //     tbody.appendChild(tr);
      //   });
      // }
      function renderPurchaseTable(data) {
        const tbody = document
          .getElementById("purchaseTable")
          .querySelector("tbody");
        tbody.innerHTML = "";

        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><i class="fas fa-envelope" style="color: var(--primary-color); margin-right: 8px;"></i>${
              row.email
            }</td>
            <td><i class="fas fa-phone" style="color: var(--success-color); margin-right: 8px;"></i>${
              row.phone_number
            }</td>
            <td><i class="fas fa-box" style="color: var(--info-color); margin-right: 8px;"></i>${
              row.title
            }</td>
            <td><i class="fas fa-rupee-sign" style="color: var(--success-color); margin-right: 8px;"></i>${
              row.total_price
            }</td>
            <td><i class="fas fa-calculator" style="color: var(--warning-color); margin-right: 8px;"></i>${
              row.cogs
            }</td>
            <td><i class="fas fa-chart-line" style="color: var(--success-color); margin-right: 8px;"></i>${
              row.profit
            }</td>
            <td><i class="fas fa-clock" style="color: var(--info-color); margin-right: 8px;"></i>${new Date(
              row.created_at
            ).toLocaleString()}</td>
            <td><i class="fas fa-hashtag" style="color: var(--primary-color); margin-right: 8px;"></i>${
              row.order_number
            }</td>

          `;
          tbody.appendChild(tr);
        });
      }

      function exportToExcel() {
        const table = document.getElementById("purchaseTable");
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table, { raw: true });
        XLSX.utils.book_append_sheet(wb, ws, "Purchases");
        XLSX.writeFile(wb, "purchase_data.xlsx");
      }
    </script>
  </body>
</html>
